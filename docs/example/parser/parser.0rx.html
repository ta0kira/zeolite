<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="Generator" content="Kate, the KDE Advanced Text Editor" />
<title>parser.0rx</title>
</head>
<!-- Highlighting: "Zeolite" -->
<body>
<pre style='color:#1f1c1b;background-color:#ffffff;'>
<b>define</b> <b><span style='color:#0057ae;'>ParseState</span></b> {
  <b>refines</b> <span style='color:#0057ae;'>ParseContext</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span>

  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>String</span></i>             data
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i>                index
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i>                line
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i>                char
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>ErrorOr</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span>        value
  <span style='color:#644a9b;'>@value</span> <b>optional</b> <i><span style='color:#0057ae;'>Formatted</span></i> error

  consumeAll (parser,data) {
    <span style='color:#0057ae;'>ParseContext</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#y</span></i><span style='color:#c02040;'>&gt;</span> context &lt;- parser.run(new(data))
    <b>if</b> (context.hasAnyError()) {
      <b>return</b> context.getValue()
    } <b>elif</b> (!context.atEof()) {
      <b>return</b> <span style='color:#0057ae;'>ErrorOr</span><span style='color:#644a9b;'>$$</span>error(<span style='color:#bf0303;'>&quot;Parsing did not consume all of the data &quot;</span> + context.getPosition())
    } <b>else</b> {
      <b>return</b> context.getValue()
    }
  }

  run (parser) {
    <b>return</b> parser.run(<b>self</b>)
  }

  runAndGet (parser) {
    <span style='color:#0057ae;'>ParseContext</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#y</span></i><span style='color:#c02040;'>&gt;</span> context &lt;- parser.run(<b>self</b>)
    <b>return</b> context, context.getValue()
  }

  getValue () {
    <b>if</b> (<b>present</b>(error)) {
      <b>return</b> <span style='color:#0057ae;'>ErrorOr</span><span style='color:#644a9b;'>$$</span>error(<b>require</b>(error))
    } <b>else</b> {
      <b>return</b> value
    }
  }

  convertError () {
    <b>return</b> <span style='color:#0057ae;'>ParseState</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#y</span></i><span style='color:#c02040;'>&gt;</span>{ data, index, line, char, <span style='color:#0057ae;'>ErrorOr</span><span style='color:#644a9b;'>$$</span>error(getError()), error }
  }

  setValue (value2) {
    <b>if</b> (hasBrokenInput()) {
      <b>return</b> convertError&lt;<i><span style='color:#0057ae;'>#y</span></i>&gt;()
    } <b>else</b> {
      <b>return</b> <span style='color:#0057ae;'>ParseState</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#y</span></i><span style='color:#c02040;'>&gt;</span>{ data, index, line, char, value2, error }
    }
  }

  setBrokenInput (message) {
    <b>return</b> <span style='color:#0057ae;'>ParseState</span><span style='color:#c02040;'>&lt;</span><b>all</b><span style='color:#c02040;'>&gt;</span>{ data, index, line, char, <span style='color:#0057ae;'>ErrorOr</span><span style='color:#644a9b;'>$$</span>error(message), message }
  }

  toState () {
    <b>return</b> <b>self</b>
  }

  getPosition () {
    <b>return</b> <i><span style='color:#0057ae;'>String</span></i><span style='color:#644a9b;'>$</span>builder()
        .append(<span style='color:#bf0303;'>&quot;[line: &quot;</span>)
        .append(line.formatted())
        .append(<span style='color:#bf0303;'>&quot;, char: &quot;</span>)
        .append(char.formatted())
        .append(<span style='color:#bf0303;'>&quot;]&quot;</span>)
        .build()
  }

  atEof () {
    <b>return</b> index &gt;= data.readSize()
  }

  hasAnyError () {
    <b>return</b> <b>present</b>(error) || value.isError()
  }

  hasBrokenInput () {
    <b>return</b> <b>present</b>(error)
  }

  current () {
    <span style='color:#006e28;'>\</span> sanityCheck()
    <b>return</b> data.readPosition(index)
  }

  advance () {
    <span style='color:#006e28;'>\</span> sanityCheck()
    <b>if</b> (data.readPosition(index) == <span style='color:#924c9d;'>'\n'</span>) {
      <b>return</b> <span style='color:#0057ae;'>ParseState</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span>{ data, index+<span style='color:#b08000;'>1</span>, line+<span style='color:#b08000;'>1</span>, <span style='color:#b08000;'>1</span>, value, error }
    } <b>else</b> {
      <b>return</b> <span style='color:#0057ae;'>ParseState</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span>{ data, index+<span style='color:#b08000;'>1</span>, line, char+<span style='color:#b08000;'>1</span>, value, error }
    }
  }

  <span style='color:#644a9b;'>@category</span> new (<i><span style='color:#0057ae;'>String</span></i>) -&gt; (<span style='color:#0057ae;'>ParseState</span><span style='color:#c02040;'>&lt;</span><b>any</b><span style='color:#c02040;'>&gt;</span>)
  new (data) {
    <b>return</b> <span style='color:#0057ae;'>ParseState</span><span style='color:#c02040;'>&lt;</span><b>any</b><span style='color:#c02040;'>&gt;</span>{ data, <span style='color:#b08000;'>0</span>, <span style='color:#b08000;'>1</span>, <span style='color:#b08000;'>1</span>, <span style='color:#0057ae;'>ErrorOr</span><span style='color:#644a9b;'>$$</span>value&lt;<b>?</b>&gt;(<span style='color:#0057ae;'>Void</span><span style='color:#644a9b;'>$</span>void()), <b>empty</b> }
  }

  <span style='color:#644a9b;'>@value</span> getError () -&gt; (<i><span style='color:#0057ae;'>Formatted</span></i>)
  getError () {
    <b>if</b> (<b>present</b>(error)) {
      <b>return</b> <b>require</b>(error)
    } <b>else</b> {
      <b>return</b> value.getError()
    }
  }

  <span style='color:#644a9b;'>@value</span> sanityCheck () -&gt; ()
  sanityCheck () {
    <b>if</b> (hasBrokenInput()) {
      <span style='color:#006e28;'>\</span> <span style='color:#0057ae;'>LazyStream</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>Formatted</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>$</span>new()
          .append(<span style='color:#bf0303;'>&quot;Error at &quot;</span>)
          .append(getPosition())
          .append(<span style='color:#bf0303;'>&quot;: &quot;</span>)
          .append(getError())
          .writeTo(<span style='color:#0057ae;'>SimpleOutput</span><span style='color:#644a9b;'>$</span>error())
    }
    <b>if</b> (atEof()) {
      <span style='color:#006e28;'>\</span> <span style='color:#0057ae;'>LazyStream</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>Formatted</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>$</span>new()
          .append(<span style='color:#bf0303;'>&quot;Reached end of input at &quot;</span>)
          .append(getPosition())
          .writeTo(<span style='color:#0057ae;'>SimpleOutput</span><span style='color:#644a9b;'>$</span>error())
    }
  }
}
</pre>
</body>
</html>
