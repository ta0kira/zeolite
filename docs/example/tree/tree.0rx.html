<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="Generator" content="Kate, the KDE Advanced Text Editor" />
<title>tree.0rx</title>
</head>
<!-- Highlighting: "Zeolite" -->
<body>
<pre style='color:#1f1c1b;background-color:#ffffff;'>
<b>define</b> <b><span style='color:#0057ae;'>Tree</span></b> {
  <span style='color:#644a9b;'>@value</span> <b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> root

  new () {
    <b>return</b> <span style='color:#0057ae;'>Tree</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>{ <b>empty</b> }
  }

  set (k,v) {
    root &lt;- <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>.</span>insert(root,k,v)
    <b>return</b> <b>self</b>
  }

  remove (k) {
    root &lt;- <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>.</span>delete(root,k)
    <b>return</b> <b>self</b>
  }

  get (k) {
    <b>return</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>.</span>find(root,k)
  }
}

<span style='color:#898887;'>/*</span><span style='color:#898887;'> Represents the root of a subtree.</span>
<span style='color:#898887;'> *</span>
<span style='color:#898887;'> * Since this category is not declared in the .0rp, it is only visible within</span>
<span style='color:#898887;'> * this .0rx file.</span>
<span style='color:#898887;'> *</span>
<span style='color:#898887;'> * This is separate from Tree so that the root can be empty, but Node otherwise</span>
<span style='color:#898887;'> * handles all of the tree logic.</span>
<span style='color:#898887;'> </span><span style='color:#898887;'>*/</span>
<b>concrete</b> <b><span style='color:#0057ae;'>Node</span></b><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> {
  <i><span style='color:#0057ae;'>#k</span></i> <b>defines</b> <i><span style='color:#0057ae;'>LessThan</span></i><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i><span style='color:#c02040;'>&gt;</span>

  <span style='color:#898887;'>// The functions below are the only ones visible to Tree. Other functions are</span>
  <span style='color:#898887;'>// declared in the definition of Node, and are only accessible to other</span>
  <span style='color:#898887;'>// functions within Node.</span>

  <span style='color:#644a9b;'>@type</span> insert (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>,<i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i>) -&gt; (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>)
  <span style='color:#644a9b;'>@type</span> delete (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>,<i><span style='color:#0057ae;'>#k</span></i>) -&gt; (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>)
  <span style='color:#644a9b;'>@type</span> find (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>,<i><span style='color:#0057ae;'>#k</span></i>) -&gt; (<b>optional</b> <i><span style='color:#0057ae;'>#v</span></i>)
}

<b>define</b> <b><span style='color:#0057ae;'>Node</span></b> {
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> height
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>#k</span></i> key
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>#v</span></i> value
  <span style='color:#644a9b;'>@value</span> <b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> lower
  <span style='color:#644a9b;'>@value</span> <b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> higher

  insert (node,k,v) {
    <b>if</b> (!<b>present</b>(node)) {
      <b>return</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>{ <span style='color:#b08000;'>1</span>, k, v, <b>empty</b>, <b>empty</b> }
    }
    <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> node2 &lt;- <b>require</b>(node)
    <b>if</b> (k <b><span style='color:#c02040;'>`</span></b><i><span style='color:#0057ae;'>#k</span></i><span style='color:#644a9b;'>.</span>lessThan<b><span style='color:#c02040;'>`</span></b> node2<span style='color:#644a9b;'>.</span>getKey()) {
      <span style='color:#006e28;'>\</span> node2<span style='color:#644a9b;'>.</span>setLower(insert(node2<span style='color:#644a9b;'>.</span>getLower(),k,v))
      <b>return</b> rebalance(node2)
    } <b>elif</b> (node2<span style='color:#644a9b;'>.</span>getKey() <b><span style='color:#c02040;'>`</span></b><i><span style='color:#0057ae;'>#k</span></i><span style='color:#644a9b;'>.</span>lessThan<b><span style='color:#c02040;'>`</span></b> k) {
      <span style='color:#006e28;'>\</span> node2<span style='color:#644a9b;'>.</span>setHigher(insert(node2<span style='color:#644a9b;'>.</span>getHigher(),k,v))
      <b>return</b> rebalance(node2)
    } <b>else</b> {
      <span style='color:#006e28;'>\</span> node2<span style='color:#644a9b;'>.</span>setValue(v)
      <b>return</b> node2
    }
  }

  delete (node,k) {
    <b>if</b> (!<b>present</b>(node)) {
      <b>return</b> <b>empty</b>
    }
    <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> node2 &lt;- <b>require</b>(node)
    <b>if</b> (k <b><span style='color:#c02040;'>`</span></b><i><span style='color:#0057ae;'>#k</span></i><span style='color:#644a9b;'>.</span>lessThan<b><span style='color:#c02040;'>`</span></b> node2<span style='color:#644a9b;'>.</span>getKey()) {
      <span style='color:#006e28;'>\</span> node2<span style='color:#644a9b;'>.</span>setLower(delete(node2<span style='color:#644a9b;'>.</span>getLower(),k))
      <b>return</b> rebalance(node2)
    } <b>elif</b> (node2<span style='color:#644a9b;'>.</span>getKey() <b><span style='color:#c02040;'>`</span></b><i><span style='color:#0057ae;'>#k</span></i><span style='color:#644a9b;'>.</span>lessThan<b><span style='color:#c02040;'>`</span></b> k) {
      <span style='color:#006e28;'>\</span> node2<span style='color:#644a9b;'>.</span>setHigher(delete(node2<span style='color:#644a9b;'>.</span>getHigher(),k))
      <b>return</b> rebalance(node2)
    } <b>else</b> {
      <b>return</b> rebalance(removeNode(node2))
    }
  }

  find (node,k) {
    <b>if</b> (<b>present</b>(node)) {
      <b>scoped</b> {
        <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> node2 &lt;- <b>require</b>(node)
      } <b>in</b> <b>if</b> (k <b><span style='color:#c02040;'>`</span></b><i><span style='color:#0057ae;'>#k</span></i><span style='color:#644a9b;'>.</span>lessThan<b><span style='color:#c02040;'>`</span></b> node2<span style='color:#644a9b;'>.</span>getKey()) {
        <b>return</b> find(node2<span style='color:#644a9b;'>.</span>getLower(),k)
      } <b>elif</b> (node2<span style='color:#644a9b;'>.</span>getKey() <b><span style='color:#c02040;'>`</span></b><i><span style='color:#0057ae;'>#k</span></i><span style='color:#644a9b;'>.</span>lessThan<b><span style='color:#c02040;'>`</span></b> k) {
        <b>return</b> find(node2<span style='color:#644a9b;'>.</span>getHigher(),k)
      } <b>else</b> {
        <b>return</b> node2<span style='color:#644a9b;'>.</span>getValue()
      }
    } <b>else</b> {
      <b>return</b> <b>empty</b>
    }
  }

  <span style='color:#644a9b;'>@value</span> updateHeight () -&gt; ()
  updateHeight () {
    <b>scoped</b> {
      <i><span style='color:#0057ae;'>Int</span></i> l &lt;- <span style='color:#b08000;'>0</span>
      <i><span style='color:#0057ae;'>Int</span></i> h &lt;- <span style='color:#b08000;'>0</span>
      <b>if</b> (<b>present</b>(lower)) {
        l &lt;- <b>require</b>(lower)<span style='color:#644a9b;'>.</span>getHeight()
      }
      <b>if</b> (<b>present</b>(higher)) {
        h &lt;- <b>require</b>(higher)<span style='color:#644a9b;'>.</span>getHeight()
      }
    } <b>in</b> <b>if</b> (l &gt; h) {
      height &lt;- l + <span style='color:#b08000;'>1</span>
    } <b>else</b> {
      height &lt;- h + <span style='color:#b08000;'>1</span>
    }
  }

  <span style='color:#644a9b;'>@value</span> getBalance () -&gt; (<i><span style='color:#0057ae;'>Int</span></i>)
  getBalance () {
    <b>scoped</b> {
      <i><span style='color:#0057ae;'>Int</span></i> l &lt;- <span style='color:#b08000;'>0</span>
      <i><span style='color:#0057ae;'>Int</span></i> h &lt;- <span style='color:#b08000;'>0</span>
      <b>if</b> (<b>present</b>(lower)) {
        l &lt;- <b>require</b>(lower)<span style='color:#644a9b;'>.</span>getHeight()
      }
      <b>if</b> (<b>present</b>(higher)) {
        h &lt;- <b>require</b>(higher)<span style='color:#644a9b;'>.</span>getHeight()
      }
    } <b>in</b> <b>return</b> h - l
  }

  <span style='color:#644a9b;'>@type</span> rebalance (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>)
  rebalance (node) {
    <b>if</b> (!<b>present</b>(node)) {
      <b>return</b> <b>empty</b>
    }
    <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> node2 &lt;- <b>require</b>(node)
    <span style='color:#006e28;'>\</span> node2<span style='color:#644a9b;'>.</span>updateHeight()
    <b>scoped</b> {
      <i><span style='color:#0057ae;'>Int</span></i> balance &lt;- node2<span style='color:#644a9b;'>.</span>getBalance()
    } <b>in</b> <b>if</b> (balance &gt; <span style='color:#b08000;'>1</span>) {
      <b>return</b> pivotLower(node2)
    } <b>elif</b> (balance &lt; -<span style='color:#b08000;'>1</span>) {
      <b>return</b> pivotHigher(node2)
    } <b>else</b> {
      <b>return</b> node2
    }
  }

  <span style='color:#644a9b;'>@type</span> pivotHigher (<span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; (<span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>)
  pivotHigher (node) (newNode) {
    <b>if</b> (<b>require</b>(node<span style='color:#644a9b;'>.</span>getLower())<span style='color:#644a9b;'>.</span>getBalance() &gt; <span style='color:#b08000;'>0</span>) {
      <span style='color:#006e28;'>\</span> node<span style='color:#644a9b;'>.</span>setLower(pivotLower(<b>require</b>(node<span style='color:#644a9b;'>.</span>getLower())))
    }
    newNode &lt;- <b>require</b>(node<span style='color:#644a9b;'>.</span>getLower())
    <span style='color:#006e28;'>\</span> node<span style='color:#644a9b;'>.</span>setLower(newNode<span style='color:#644a9b;'>.</span>getHigher())
    <span style='color:#006e28;'>\</span> node<span style='color:#644a9b;'>.</span>updateHeight()
    <span style='color:#006e28;'>\</span> newNode<span style='color:#644a9b;'>.</span>setHigher(node)
    <span style='color:#006e28;'>\</span> newNode<span style='color:#644a9b;'>.</span>updateHeight()
  }

  <span style='color:#644a9b;'>@type</span> pivotLower (<span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; (<span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>)
  pivotLower (node) (newNode) {
    <b>if</b> (<b>require</b>(node<span style='color:#644a9b;'>.</span>getHigher())<span style='color:#644a9b;'>.</span>getBalance() &lt; <span style='color:#b08000;'>0</span>) {
      <span style='color:#006e28;'>\</span> node<span style='color:#644a9b;'>.</span>setHigher(pivotHigher(<b>require</b>(node<span style='color:#644a9b;'>.</span>getHigher())))
    }
    newNode &lt;- <b>require</b>(node<span style='color:#644a9b;'>.</span>getHigher())
    <span style='color:#006e28;'>\</span> node<span style='color:#644a9b;'>.</span>setHigher(newNode<span style='color:#644a9b;'>.</span>getLower())
    <span style='color:#006e28;'>\</span> node<span style='color:#644a9b;'>.</span>updateHeight()
    <span style='color:#006e28;'>\</span> newNode<span style='color:#644a9b;'>.</span>setLower(node)
    <span style='color:#006e28;'>\</span> newNode<span style='color:#644a9b;'>.</span>updateHeight()
  }

  <span style='color:#644a9b;'>@type</span> removeNode (<span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>)
  removeNode (node) (newNode) {
    <b>if</b> (node<span style='color:#644a9b;'>.</span>getBalance() &lt; <span style='color:#b08000;'>0</span>) {
      <b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> temp, newNode &lt;- removeHighest(node<span style='color:#644a9b;'>.</span>getLower())
      <span style='color:#006e28;'>\</span> node<span style='color:#644a9b;'>.</span>setLower(temp)
    } <b>else</b> {
      <b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> temp, newNode &lt;- removeLowest(node<span style='color:#644a9b;'>.</span>getHigher())
      <span style='color:#006e28;'>\</span> node<span style='color:#644a9b;'>.</span>setHigher(temp)
    }
    <b>if</b> (<b>present</b>(newNode)) {
      <span style='color:#006e28;'>\</span> swapChildren(node,<b>require</b>(newNode))
      <span style='color:#006e28;'>\</span> <b>require</b>(newNode)<span style='color:#644a9b;'>.</span>updateHeight()
    }
  }

  <span style='color:#644a9b;'>@type</span> removeHighest (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>,<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>)
  removeHighest (node) (newNode,removed) {
    <b>if</b> (!<b>present</b>(node)) {
      <b>return</b> <b>empty</b>, <b>empty</b>
    }
    <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> node2 &lt;- <b>require</b>(node)
    <b>if</b> (<b>present</b>(node2<span style='color:#644a9b;'>.</span>getHigher())) {
      <b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> temp, removed &lt;- removeHighest(node2<span style='color:#644a9b;'>.</span>getHigher())
      <span style='color:#006e28;'>\</span> node2<span style='color:#644a9b;'>.</span>setHigher(temp)
      newNode &lt;- rebalance(node2)
    } <b>else</b> {
      newNode &lt;- node2<span style='color:#644a9b;'>.</span>getLower()
      <span style='color:#006e28;'>\</span> node2<span style='color:#644a9b;'>.</span>setLower(<b>empty</b>)
      removed &lt;- node
    }
  }

  <span style='color:#644a9b;'>@type</span> removeLowest (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>,<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>)
  removeLowest (node) (newNode,removed) {
    <b>if</b> (!<b>present</b>(node)) {
      <b>return</b> <b>empty</b>, <b>empty</b>
    }
    <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> node2 &lt;- <b>require</b>(node)
    <b>if</b> (<b>present</b>(node2<span style='color:#644a9b;'>.</span>getLower())) {
      <b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> temp, removed &lt;- removeLowest(node2<span style='color:#644a9b;'>.</span>getLower())
      <span style='color:#006e28;'>\</span> node2<span style='color:#644a9b;'>.</span>setLower(temp)
      newNode &lt;- rebalance(node2)
    } <b>else</b> {
      newNode &lt;- node2<span style='color:#644a9b;'>.</span>getHigher()
      <span style='color:#006e28;'>\</span> node2<span style='color:#644a9b;'>.</span>setHigher(<b>empty</b>)
      removed &lt;- node
    }
  }

  <span style='color:#644a9b;'>@type</span> swapChildren (<span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>,<span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; ()
  swapChildren (l,r) {
    <b>scoped</b> {
      <b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> temp &lt;- l<span style='color:#644a9b;'>.</span>getLower()
      <span style='color:#006e28;'>\</span> l<span style='color:#644a9b;'>.</span>setLower(r<span style='color:#644a9b;'>.</span>getLower())
    } <b>in</b> <span style='color:#006e28;'>\</span> r<span style='color:#644a9b;'>.</span>setLower(temp)
    <b>scoped</b> {
      <b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span> temp &lt;- l<span style='color:#644a9b;'>.</span>getHigher()
      <span style='color:#006e28;'>\</span> l<span style='color:#644a9b;'>.</span>setHigher(r<span style='color:#644a9b;'>.</span>getHigher())
    } <b>in</b> <span style='color:#006e28;'>\</span> r<span style='color:#644a9b;'>.</span>setHigher(temp)
  }

  <span style='color:#644a9b;'>@value</span> getHeight () -&gt; (<i><span style='color:#0057ae;'>Int</span></i>)
  getHeight () { <b>return</b> height }

  <span style='color:#898887;'>// It is unsafe to change the key after construction, so there is no setter.</span>
  <span style='color:#898887;'>//</span>
  <span style='color:#898887;'>// Unlike other languages, a member is only accessible by the value that owns</span>
  <span style='color:#898887;'>// it. More specifically, @type functions in Node can only access @value</span>
  <span style='color:#898887;'>// members via explicit @value getters and setters.</span>
  <span style='color:#644a9b;'>@value</span> getKey () -&gt; (<i><span style='color:#0057ae;'>#k</span></i>)
  getKey () { <b>return</b> key }

  <span style='color:#644a9b;'>@value</span> getValue () -&gt; (<i><span style='color:#0057ae;'>#v</span></i>)
  getValue () { <b>return</b> value }

  <span style='color:#644a9b;'>@value</span> setValue (<i><span style='color:#0057ae;'>#v</span></i>) -&gt; ()
  setValue (v) { value &lt;- v }

  <span style='color:#644a9b;'>@value</span> getLower () -&gt; (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>)
  getLower () { <b>return</b> lower }

  <span style='color:#644a9b;'>@value</span> setLower (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; ()
  setLower (l) { lower &lt;- l }

  <span style='color:#644a9b;'>@value</span> getHigher () -&gt; (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>)
  getHigher () { <b>return</b> higher }

  <span style='color:#644a9b;'>@value</span> setHigher (<b>optional</b> <span style='color:#0057ae;'>Node</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#k</span></i>,<i><span style='color:#0057ae;'>#v</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; ()
  setHigher (h) { higher &lt;- h }
}
</pre>
</body>
</html>
