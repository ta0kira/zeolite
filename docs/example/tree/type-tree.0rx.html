<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="Generator" content="Kate, the KDE Advanced Text Editor" />
<title>type-tree.0rx</title>
</head>
<!-- Highlighting: "Zeolite" -->
<body>
<pre style='color:#1f1c1b;background-color:#ffffff;'>
<b>define</b> <b><span style='color:#0057ae;'>TypeTree</span></b> {
  <span style='color:#898887;'>// Since TypeKey and LockedType each have a covariant param, setting the param</span>
  <span style='color:#898887;'>// to any in Tree means that any param can be used in an assignment.</span>
  <span style='color:#898887;'>//</span>
  <span style='color:#898887;'>// The catch is that any cannot be converted to anything else, which means</span>
  <span style='color:#898887;'>// that type information is no longer directly accessible. LockedType allows</span>
  <span style='color:#898887;'>// the original type to be recovered via check, given the correct TypeKey.</span>
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>Tree</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>TypeKey</span><span style='color:#c02040;'>&lt;</span><b>any</b><span style='color:#c02040;'>&gt;</span>,<span style='color:#0057ae;'>LockedType</span><span style='color:#c02040;'>&lt;</span><b>any</b><span style='color:#c02040;'>&gt;&gt;</span> tree

  new () {
    <b>return</b> <span style='color:#0057ae;'>TypeTree</span>{ <span style='color:#0057ae;'>Tree</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>TypeKey</span><span style='color:#c02040;'>&lt;</span><b>any</b><span style='color:#c02040;'>&gt;</span>,<span style='color:#0057ae;'>LockedType</span><span style='color:#c02040;'>&lt;</span><b>any</b><span style='color:#c02040;'>&gt;&gt;</span><span style='color:#644a9b;'>$</span>new() }
  }

  set (k,v) {
    <span style='color:#006e28;'>\</span> tree<span style='color:#644a9b;'>.</span>set(k,<span style='color:#0057ae;'>LockedType</span><span style='color:#644a9b;'>:</span>create&lt;<b>?</b>&gt;(k,v))
    <b>return</b> <b>self</b>
  }

  remove (k) {
    <span style='color:#006e28;'>\</span> tree<span style='color:#644a9b;'>.</span>remove(k)
    <b>return</b> <b>self</b>
  }

  get (k) {
    <b>scoped</b> {
      <b>optional</b> <span style='color:#0057ae;'>LockedType</span><span style='color:#c02040;'>&lt;</span><b>any</b><span style='color:#c02040;'>&gt;</span> value &lt;- tree<span style='color:#644a9b;'>.</span>get(k)
    } <b>in</b> <b>if</b> (<b>present</b>(value)) {
      <b>return</b> <b>require</b>(value)<span style='color:#644a9b;'>.</span>check&lt;<b>?</b>&gt;(k)
    } <b>else</b> {
      <b>return</b> <b>empty</b>
    }
  }
}

<b>define</b> <b><span style='color:#0057ae;'>TypeKey</span></b> {
  <span style='color:#644a9b;'>@category</span> <i><span style='color:#0057ae;'>Int</span></i> counter &lt;- <span style='color:#b08000;'>0</span>
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> index

  new () {
    <b>return</b> <span style='color:#0057ae;'>TypeKey</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span>{ (counter &lt;- counter+<span style='color:#b08000;'>1</span>) }
  }

  lessThan (l,r) {
    <b>return</b> l<span style='color:#644a9b;'>.</span>get() &lt; r<span style='color:#644a9b;'>.</span>get()
  }

  equals (l,r) {
    <b>return</b> l<span style='color:#644a9b;'>.</span>get() == r<span style='color:#644a9b;'>.</span>get()
  }

  <span style='color:#644a9b;'>@value</span> get () -&gt; (<i><span style='color:#0057ae;'>Int</span></i>)
  get () {
    <b>return</b> index
  }
}

<span style='color:#898887;'>/*</span><span style='color:#898887;'> An internal type used for storing a single value.</span>
<span style='color:#898887;'> *</span>
<span style='color:#898887;'> * The contained value is only accessible via the check function, which ensures</span>
<span style='color:#898887;'> * both that the key and the type match.</span>
<span style='color:#898887;'> </span><span style='color:#898887;'>*/</span>
<b>concrete</b> <b><span style='color:#0057ae;'>LockedType</span></b><span style='color:#c02040;'>&lt;</span><span style='color:#c04040;'>|</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span> {
  <span style='color:#898887;'>// Creates a new LockedType, e.g., LockedType:create&lt;#x&gt;(k,v).</span>
  <span style='color:#644a9b;'>@category</span> create&lt;<i><span style='color:#0057ae;'>#x</span></i>&gt; (<span style='color:#0057ae;'>TypeKey</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span>,<i><span style='color:#0057ae;'>#x</span></i>) -&gt; (<span style='color:#0057ae;'>LockedType</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span>)

  <span style='color:#898887;'>// Returns the contained value if the key and type match, or empty otherwise.</span>
  <span style='color:#644a9b;'>@value</span> check&lt;<i><span style='color:#0057ae;'>#y</span></i>&gt; (<span style='color:#0057ae;'>TypeKey</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#y</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; (<b>optional</b> <i><span style='color:#0057ae;'>#y</span></i>)
}

<b>define</b> <b><span style='color:#0057ae;'>LockedType</span></b> {
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>TypeKey</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span> key
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>#x</span></i> value

  create (k,v) {
    <b>return</b> <span style='color:#0057ae;'>LockedType</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span>{ k, v }
  }

  check (k) {
    <b>if</b> (key <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>TypeKey</span><span style='color:#c02040;'>&lt;</span><b>any</b><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> k) {
      <span style='color:#898887;'>// reduce is a builtin that returns value (as optional #y) iff #x -&gt; #y.</span>
      <span style='color:#898887;'>// The runtime type of value does not matter here; it just needs to be of</span>
      <span style='color:#898887;'>// type optional #x at compile time.</span>
      <span style='color:#898887;'>//</span>
      <span style='color:#898887;'>// This is more like template meta-programming in C++ than it is like a</span>
      <span style='color:#898887;'>// runtime type cast in Java. The reduce call could in theory be replaced</span>
      <span style='color:#898887;'>// at compile time with either value or empty if parameter substitution</span>
      <span style='color:#898887;'>// happened at compile time. (Like C++ does with templates.)</span>
      <b>return</b> <b>reduce</b>&lt;<i><span style='color:#0057ae;'>#x</span></i>,<i><span style='color:#0057ae;'>#y</span></i>&gt;(value)
    } <b>else</b> {
      <b>return</b> <b>empty</b>
    }
  }
}
</pre>
</body>
</html>
