<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="Generator" content="Kate, the KDE Advanced Text Editor" />
<title>regex.0rx</title>
</head>
<!-- Highlighting: "Zeolite" -->
<body>
<pre style='color:#1f1c1b;background-color:#ffffff;'>
<b>define</b> <b><span style='color:#0057ae;'>MatchState</span></b> {
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> enum
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>String</span></i> name
  <span style='color:#644a9b;'>@category</span> <span style='color:#0057ae;'>MatchState</span> matchFailVal     &lt;- <span style='color:#0057ae;'>MatchState</span>{ <span style='color:#b08000;'>0</span>, <span style='color:#bf0303;'>&quot;matchFail&quot;</span> }
  <span style='color:#644a9b;'>@category</span> <span style='color:#0057ae;'>MatchState</span> matchCompleteVal &lt;- <span style='color:#0057ae;'>MatchState</span>{ <span style='color:#b08000;'>1</span>, <span style='color:#bf0303;'>&quot;matchComplete&quot;</span> }
  <span style='color:#644a9b;'>@category</span> <span style='color:#0057ae;'>MatchState</span> matchContinueVal &lt;- <span style='color:#0057ae;'>MatchState</span>{ <span style='color:#b08000;'>2</span>, <span style='color:#bf0303;'>&quot;matchContinue&quot;</span> }

  formatted () {
    <b>return</b> <span style='color:#bf0303;'>&quot;MatchState$&quot;</span> + name + <span style='color:#bf0303;'>&quot;()&quot;</span>
  }

  equals (x,y) {
    <b>return</b> x.getEnum() == y.getEnum()
  }

  lessThan (x,y) {
    <b>return</b> x.getEnum() &lt; y.getEnum()
  }

  matchFail () {
    <b>return</b> matchFailVal
  }

  matchComplete () {
    <b>return</b> matchCompleteVal
  }

  matchContinue () {
    <b>return</b> matchContinueVal
  }

  <span style='color:#644a9b;'>@value</span> getEnum () -&gt; (<i><span style='color:#0057ae;'>Int</span></i>)
  getEnum () {
    <b>return</b> enum
  }
}

<b>define</b> <b><span style='color:#0057ae;'>MatchSingle</span></b> {
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>#c</span></i> match

  create (match) {
    <b>return</b> <span style='color:#0057ae;'>MatchSingle</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ match }
  }

  matchesEmpty () {
    <b>return</b> <b>false</b>
  }

  newMatcher () {
    <b>return</b> <span style='color:#0057ae;'>MatchSingleMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>$</span>create(match)
  }
}

<b>concrete</b> <b><span style='color:#0057ae;'>MatchSingleMatcher</span></b><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> {
  <i><span style='color:#0057ae;'>#c</span></i> <b>defines</b> <i><span style='color:#0057ae;'>Equals</span></i><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>

  <b>refines</b> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>

  <span style='color:#644a9b;'>@type</span> create (<i><span style='color:#0057ae;'>#c</span></i>) -&gt; (<span style='color:#0057ae;'>MatchSingleMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>)
}

<b>define</b> <b><span style='color:#0057ae;'>MatchSingleMatcher</span></b> {
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>#c</span></i> match
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>MatchState</span> state

  create (match) {
    <b>return</b> <span style='color:#0057ae;'>MatchSingleMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ match, <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue() }
  }

  matchSatisfied () {
    <b>return</b> state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete()
  }

  tryNextMatch (data) {
    <b>if</b> (!(state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue())) {
      <b>return</b> (state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail())
    }
    <b>if</b> (data <b><span style='color:#c02040;'>`</span></b><i><span style='color:#0057ae;'>#c</span></i><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> match) {
      <b>return</b> (state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete())
    } <b>else</b> {
      <b>return</b> (state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail())
    }
  }
}

<b>define</b> <b><span style='color:#0057ae;'>MatchRange</span></b> {
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>#c</span></i> minMatch
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>#c</span></i> maxMatch

  create (minMatch,maxMatch) {
    <b>return</b> <span style='color:#0057ae;'>MatchRange</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ minMatch, maxMatch }
  }

  matchesEmpty () {
    <b>return</b> <b>false</b>
  }

  newMatcher () {
    <b>return</b> <span style='color:#0057ae;'>MatchRangeMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>$</span>create(minMatch,maxMatch)
  }
}

<b>concrete</b> <b><span style='color:#0057ae;'>MatchRangeMatcher</span></b><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> {
  <i><span style='color:#0057ae;'>#c</span></i> <b>defines</b> <i><span style='color:#0057ae;'>LessThan</span></i><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>

  <b>refines</b> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>

  <span style='color:#644a9b;'>@type</span> create (<i><span style='color:#0057ae;'>#c</span></i>,<i><span style='color:#0057ae;'>#c</span></i>) -&gt; (<span style='color:#0057ae;'>MatchRangeMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>)
}

<b>define</b> <b><span style='color:#0057ae;'>MatchRangeMatcher</span></b> {
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>#c</span></i> minMatch
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>#c</span></i> maxMatch
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>MatchState</span> state

  create (minMatch,maxMatch) {
    <b>return</b> <span style='color:#0057ae;'>MatchRangeMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ minMatch, maxMatch, <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue() }
  }

  matchSatisfied () {
    <b>return</b> state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete()
  }

  tryNextMatch (data) {
    <b>if</b> (!(state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue())) {
      <b>return</b> (state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail())
    }
    <b>if</b> (!(data <b><span style='color:#c02040;'>`</span></b><i><span style='color:#0057ae;'>#c</span></i><span style='color:#644a9b;'>$</span>lessThan<b><span style='color:#c02040;'>`</span></b> minMatch) &amp;&amp; !(maxMatch <b><span style='color:#c02040;'>`</span></b><i><span style='color:#0057ae;'>#c</span></i><span style='color:#644a9b;'>$</span>lessThan<b><span style='color:#c02040;'>`</span></b> data)) {
      <b>return</b> (state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete())
    } <b>else</b> {
      <b>return</b> (state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail())
    }
  }
}

<b>define</b> <b><span style='color:#0057ae;'>MatchAny</span></b> {
  create () {
    <b>return</b> <span style='color:#0057ae;'>MatchAny</span>{ }
  }

  matchesEmpty () {
    <b>return</b> <b>false</b>
  }

  newMatcher () {
    <b>return</b> <span style='color:#0057ae;'>MatchAnyMatcher</span><span style='color:#644a9b;'>$</span>create()
  }
}

<b>concrete</b> <b><span style='color:#0057ae;'>MatchAnyMatcher</span></b> {
  <b>refines</b> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><b>any</b><span style='color:#c02040;'>&gt;</span>

  <span style='color:#644a9b;'>@type</span> create () -&gt; (<span style='color:#0057ae;'>MatchAnyMatcher</span>)
}

<b>define</b> <b><span style='color:#0057ae;'>MatchAnyMatcher</span></b> {
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>MatchState</span> state

  create () {
    <b>return</b> <span style='color:#0057ae;'>MatchAnyMatcher</span>{ <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue() }
  }

  matchSatisfied () {
    <b>return</b> state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete()
  }

  tryNextMatch (data) {
    <b>if</b> (!(state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue())) {
      <b>return</b> (state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail())
    }
    <b>return</b> (state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete())
  }
}

<b>define</b> <b><span style='color:#0057ae;'>MatchEmpty</span></b> {
  create () {
    <b>return</b> <span style='color:#0057ae;'>MatchEmpty</span>{ }
  }

  matchesEmpty () {
    <b>return</b> <b>true</b>
  }

  newMatcher () {
    <b>return</b> <span style='color:#0057ae;'>MatchEmptyMatcher</span><span style='color:#644a9b;'>$</span>create()
  }
}

<b>concrete</b> <b><span style='color:#0057ae;'>MatchEmptyMatcher</span></b> {
  <b>refines</b> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><b>any</b><span style='color:#c02040;'>&gt;</span>

  <span style='color:#644a9b;'>@type</span> create () -&gt; (<span style='color:#0057ae;'>MatchEmptyMatcher</span>)
}

<b>define</b> <b><span style='color:#0057ae;'>MatchEmptyMatcher</span></b> {
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Bool</span></i> failed

  create () {
    <b>return</b> <span style='color:#0057ae;'>MatchEmptyMatcher</span>{ <b>false</b> }
  }

  matchSatisfied () {
    <b>return</b> !failed
  }

  tryNextMatch (data) {
    failed &lt;- <b>true</b>
    <b>return</b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail()
  }
}

<b>define</b> <b><span style='color:#0057ae;'>MatchRepeat</span></b> {
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> template
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> minCount
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> maxCount

  createZeroPlus (template) {
    <b>return</b> createRange(<span style='color:#b08000;'>0</span>,<span style='color:#b08000;'>0</span>,template)
  }

  createOnePlus (template) {
    <b>return</b> createRange(<span style='color:#b08000;'>1</span>,<span style='color:#b08000;'>0</span>,template)
  }

  createRange (minCount,maxCount,template) {
    <b>return</b> <span style='color:#0057ae;'>MatchRepeat</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ template, minCount, maxCount }
  }

  matchesEmpty () {
    <b>return</b> minCount &lt;= <span style='color:#b08000;'>0</span> || template.matchesEmpty()
  }

  newMatcher () {
    <b>return</b> <span style='color:#0057ae;'>MatchRepeatMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>$</span>create(minCount,maxCount,template)
  }
}

<b>concrete</b> <b><span style='color:#0057ae;'>MatchRepeatMatcher</span></b><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> {
  <b>refines</b> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>

  <span style='color:#644a9b;'>@type</span> create (<i><span style='color:#0057ae;'>Int</span></i>,<i><span style='color:#0057ae;'>Int</span></i>,<span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; (<span style='color:#0057ae;'>MatchRepeatMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>)
}

<b>define</b> <b><span style='color:#0057ae;'>MatchRepeatMatcher</span></b> {
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> template
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> matcher
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> minCount
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> maxCount <span style='color:#898887;'>// 0 means unlimited.</span>
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> repetitionCount
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>MatchState</span> lastState

  create (minCount,maxCount,template) {
    <b>return</b> <span style='color:#0057ae;'>MatchRepeatMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ template, template.newMatcher(), minCount,
                                   maxCount, <span style='color:#b08000;'>0</span>, <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete() }
  }

  matchSatisfied () {
    <b>if</b> (lastState <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail()) {
      <b>return</b> <b>false</b>
    }
    <b>if</b> (lastState <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue() &amp;&amp;
        (repetitionCount+<span style='color:#b08000;'>1</span> &gt;= minCount || template.matchesEmpty()) &amp;&amp;
        matcher.matchSatisfied()) {
      <span style='color:#898887;'>// The rest of the current repetition can be ignored.</span>
      <b>return</b> <b>true</b>
    }
    <b>if</b> (lastState <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete() &amp;&amp;
        (repetitionCount &gt;= minCount || template.matchesEmpty())) {
      <b>return</b> <b>true</b>
    }
    <b>return</b> <b>false</b>
  }

  tryNextMatch (data) (state) {
    <b>if</b> (atMax() || lastState <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail()) {
      <b>return</b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail()
    }
    <i><span style='color:#0057ae;'>Bool</span></i> canSkip &lt;- matcher.matchSatisfied()
    state &lt;- matcher.tryNextMatch(data)
    <b>if</b> (state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail() &amp;&amp;
        lastState <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue() &amp;&amp; canSkip) {
      <span style='color:#898887;'>// Handle the case where an optional end to the pattern can be skipped.</span>
      <span style='color:#006e28;'>~</span> incrementMatch()
      <span style='color:#006e28;'>~</span> startRepeat()
      state &lt;- matcher.tryNextMatch(data)
    }
    lastState &lt;- state
    <b>if</b> (state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete()) {
      <span style='color:#006e28;'>~</span> incrementMatch()
      <span style='color:#006e28;'>~</span> startRepeat()
      <b>if</b> (atMax()) {
        state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete()
      } <b>else</b> {
        state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue()
      }
    }
  }

  <span style='color:#644a9b;'>@value</span> incrementMatch () -&gt; ()
  incrementMatch () {
    repetitionCount &lt;- repetitionCount+<span style='color:#b08000;'>1</span>
  }

  <span style='color:#644a9b;'>@value</span> atMax () -&gt; (<i><span style='color:#0057ae;'>Bool</span></i>)
  atMax () {
    <b>return</b> maxCount &gt; <span style='color:#b08000;'>0</span> &amp;&amp; repetitionCount &gt;= maxCount
  }

  <span style='color:#644a9b;'>@value</span> startRepeat () -&gt; ()
  startRepeat () {
    matcher &lt;- template.newMatcher()
  }
}

<b>define</b> <b><span style='color:#0057ae;'>MatchChoices</span></b> {
  <span style='color:#644a9b;'>@value</span> <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> choices

  create (choices) {
    <b>return</b> <span style='color:#0057ae;'>MatchChoices</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ choices }
  }

  matchesEmpty () {
    <b>scoped</b> {
      <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> current &lt;- choices
    } <b>in</b> <b>while</b> (<b>present</b>(current)) {
      <b>if</b> (<b>require</b>(current).value().matchesEmpty()) {
        <b>return</b> <b>true</b>
      }
    } <b>update</b> {
      current &lt;- <b>require</b>(current).next()
    }
    <b>return</b> <b>false</b>
  }

  newMatcher () {
    <b>return</b> <span style='color:#0057ae;'>MatchChoicesMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>$</span>create(recursiveNewMatcher(choices))
  }

  <span style='color:#644a9b;'>@type</span> recursiveNewMatcher (<b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span>) -&gt;
                            (<b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span>)
  recursiveNewMatcher (choices) {
    <b>if</b> (!<b>present</b>(choices)) {
      <b>return</b> <b>empty</b>
    }
    <b>return</b> <span style='color:#0057ae;'>LinkedNode</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span><span style='color:#644a9b;'>$</span>create(<b>require</b>(choices).value().newMatcher(),
                                          recursiveNewMatcher(<b>require</b>(choices).next()))
  }
}

<b>concrete</b> <b><span style='color:#0057ae;'>MatchChoicesMatcher</span></b><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> {
  <b>refines</b> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>

  <span style='color:#644a9b;'>@type</span> create (<b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span>) -&gt; (<span style='color:#0057ae;'>MatchChoicesMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>)
}

<b>define</b> <b><span style='color:#0057ae;'>MatchChoicesMatcher</span></b> {
  <span style='color:#644a9b;'>@value</span> <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> choices

  create (choices) {
    <b>return</b> <span style='color:#0057ae;'>MatchChoicesMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ choices }
  }

  matchSatisfied () {
    <b>scoped</b> {
      <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> current &lt;- choices
    } <b>in</b> <b>while</b> (<b>present</b>(current)) {
      <b>if</b> (<b>require</b>(current).value().matchSatisfied()) {
        <b>return</b> <b>true</b>
      }
    } <b>update</b> {
      current &lt;- <b>require</b>(current).next()
    }
    <b>return</b> <b>false</b>
  }

  tryNextMatch (data) (state) {
    state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail()
    <b>scoped</b> {
      <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> current &lt;- choices
    } <b>in</b> <b>while</b> (<b>present</b>(current)) {
      <span style='color:#898887;'>// NOTE: Failing matchers are left in for simplicity, under the assumption</span>
      <span style='color:#898887;'>// that they will keep failing.</span>
      <span style='color:#0057ae;'>MatchState</span> state2 &lt;- <b>require</b>(current).value().tryNextMatch(data)
      <b>if</b> (state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>lessThan<b><span style='color:#c02040;'>`</span></b> state2) {
        state &lt;- state2
      }
    } <b>update</b> {
      current &lt;- <b>require</b>(current).next()
    }
  }
}

<b>define</b> <b><span style='color:#0057ae;'>MatchBranches</span></b> {
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>MatchBrancherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> template

  create (template) {
    <b>return</b> <span style='color:#0057ae;'>MatchBranches</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ template }
  }

  matchesEmpty () {
    <b>return</b> template.matchesEmpty()
  }

  newMatcher () {
    <b>return</b> <span style='color:#0057ae;'>MatchBranchesMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>$</span>create(template.newBrancher())
  }
}

<b>concrete</b> <b><span style='color:#0057ae;'>MatchBranchesMatcher</span></b><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> {
  <b>refines</b> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>

  <span style='color:#644a9b;'>@type</span> create (<span style='color:#0057ae;'>MatchBrancher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; (<span style='color:#0057ae;'>MatchBranchesMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>)
}

<b>define</b> <b><span style='color:#0057ae;'>MatchBranchesMatcher</span></b> {
  <span style='color:#644a9b;'>@value</span> <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatchBrancher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> branches
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Bool</span></i> complete

  create (brancher) {
    <b>return</b> <span style='color:#0057ae;'>MatchBranchesMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ <span style='color:#0057ae;'>LinkedNode</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatchBrancher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span><span style='color:#644a9b;'>$</span>create(brancher,<b>empty</b>), <b>false</b> }
  }

  matchSatisfied () {
    <b>if</b> (complete) {
      <b>return</b> <b>true</b>
    }
    <b>scoped</b> {
      <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatchBrancher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> current &lt;- branches
    } <b>in</b> <b>while</b> (<b>present</b>(current)) {
      <b>if</b> (<b>require</b>(current).value().matchSatisfied()) {
        <b>return</b> <b>true</b>
      }
    } <b>update</b> {
      current &lt;- <b>require</b>(current).next()
    }
    <b>return</b> <b>false</b>
  }

  tryNextMatch (data) (state) {
    state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail()
    <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatchBrancher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> current &lt;- branches
    branches &lt;- <b>empty</b>
    complete &lt;- <b>false</b>
    <b>scoped</b> {
    } <b>in</b> <b>while</b>(<b>present</b>(current)) {
      <span style='color:#0057ae;'>MatchState</span> state2, <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatchBrancher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> branches2 &lt;-
          <b>require</b>(current).value().tryBranches(data)
      <b>if</b> (state2 <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete()) {
        complete &lt;- <b>true</b>
      }
      <b>if</b> (state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>lessThan<b><span style='color:#c02040;'>`</span></b> state2) {
        state &lt;- state2
      }
      branches &lt;- <span style='color:#0057ae;'>LinkedNode</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatchBrancher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span><span style='color:#644a9b;'>$</span>concatSequences(branches2,branches)
    } <b>update</b> {
      current &lt;- <b>require</b>(current).next()
    }
  }
}

<b>concrete</b> <b><span style='color:#0057ae;'>BranchRepeatMatcher</span></b><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> {
  <b>refines</b> <span style='color:#0057ae;'>MatchBrancher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>

  <span style='color:#644a9b;'>@type</span> create (<i><span style='color:#0057ae;'>Int</span></i>,<i><span style='color:#0057ae;'>Int</span></i>,<span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>) -&gt; (<span style='color:#0057ae;'>BranchRepeatMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>)
  <span style='color:#644a9b;'>@value</span> tryBranches (<i><span style='color:#0057ae;'>#c</span></i>) -&gt; (<span style='color:#0057ae;'>MatchState</span>,<b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>BranchRepeatMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span>)
}

<b>define</b> <b><span style='color:#0057ae;'>BranchRepeatMatcher</span></b> {
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> template
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> matcher
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> minCount
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> maxCount <span style='color:#898887;'>// 0 means unlimited.</span>
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> repetitionCount
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>MatchState</span> lastState

  create (minCount,maxCount,template) {
    <b>return</b> <span style='color:#0057ae;'>BranchRepeatMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ template, template.newMatcher(), minCount,
                                    maxCount, <span style='color:#b08000;'>0</span>, <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete() }
  }

  matchSatisfied () {
    <b>if</b> (lastState <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail()) {
      <b>return</b> <b>false</b>
    }
    <b>if</b> (lastState <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue() &amp;&amp;
        (repetitionCount+<span style='color:#b08000;'>1</span> &gt;= minCount || template.matchesEmpty()) &amp;&amp;
        matcher.matchSatisfied()) {
      <span style='color:#898887;'>// The rest of the current repetition can be ignored.</span>
      <b>return</b> <b>true</b>
    }
    <b>if</b> (lastState <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete() &amp;&amp;
        (repetitionCount &gt;= minCount || template.matchesEmpty())) {
      <b>return</b> <b>true</b>
    }
    <b>return</b> <b>false</b>
  }

  tryBranches (data) (state,branch) {
    state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail()
    branch &lt;- <b>empty</b>
    <b>if</b> (atMax() || lastState <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail()) {
      <b>return</b> <b>_</b>
    }
    <b>if</b> (lastState <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue()) {
      <span style='color:#898887;'>// Handle a possible single branch.</span>
      <i><span style='color:#0057ae;'>Bool</span></i> canSkip &lt;- matcher.matchSatisfied()
      state &lt;- matcher.tryNextMatch(data)
      <b>if</b> (canSkip) {
        <b>if</b> (state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue()) {
          <span style='color:#898887;'>// Add a branch for the optional suffix.</span>
          branch &lt;- <span style='color:#0057ae;'>LinkedNode</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>BranchRepeatMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span><span style='color:#644a9b;'>$</span>create(
              <span style='color:#0057ae;'>BranchRepeatMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ template, matcher, minCount,
                                       maxCount, repetitionCount,
                                       <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue() },<b>empty</b>)
        }
        <span style='color:#898887;'>// Continue, skipping over the optional suffix.</span>
        <span style='color:#006e28;'>~</span> incrementMatch()
        <span style='color:#006e28;'>~</span> startRepeat()
        <b>if</b> (atMax()) {
          <span style='color:#898887;'>// Skipping the branch puts us at the max.</span>
          <b>return</b> <b>_</b>
        }
        state &lt;- matcher.tryNextMatch(data)
      }
    } <b>else</b> {
      <span style='color:#898887;'>// Branching is not possible.</span>
      state &lt;- matcher.tryNextMatch(data)
    }
    lastState &lt;- state
    <b>if</b> (state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete()) {
      <span style='color:#006e28;'>~</span> incrementMatch()
      <span style='color:#006e28;'>~</span> startRepeat()
      <b>if</b> (!atMax()) {
        branch &lt;- <span style='color:#0057ae;'>LinkedNode</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>BranchRepeatMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span><span style='color:#644a9b;'>$</span>create(<b>self</b>,branch)
      }
    } <b>elif</b> (state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue()) {
      branch &lt;- <span style='color:#0057ae;'>LinkedNode</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>BranchRepeatMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span><span style='color:#644a9b;'>$</span>create(<b>self</b>,branch)
    }
    <b>if</b> (<b>present</b>(branch)) {
      state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue()
    }
  }

  <span style='color:#644a9b;'>@value</span> incrementMatch () -&gt; ()
  incrementMatch () {
    repetitionCount &lt;- repetitionCount+<span style='color:#b08000;'>1</span>
  }

  <span style='color:#644a9b;'>@value</span> atMax () -&gt; (<i><span style='color:#0057ae;'>Bool</span></i>)
  atMax () {
    <b>return</b> maxCount &gt; <span style='color:#b08000;'>0</span> &amp;&amp; repetitionCount &gt;= maxCount
  }

  <span style='color:#644a9b;'>@value</span> startRepeat () -&gt; ()
  startRepeat () {
    matcher &lt;- template.newMatcher()
  }
}

<b>define</b> <b><span style='color:#0057ae;'>BranchSequence</span></b> {
  <span style='color:#644a9b;'>@value</span> <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> sequence

  create (sequence) {
    <b>return</b> <span style='color:#0057ae;'>BranchSequence</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ sequence }
  }

  matchesEmpty () {
    <b>scoped</b> {
      <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> current &lt;- sequence
    } <b>in</b> <b>while</b> (<b>present</b>(current)) {
      <b>if</b> (!<b>require</b>(current).value().matchesEmpty()) {
        <b>return</b> <b>false</b>
      }
    } <b>update</b> {
      current &lt;- <b>require</b>(current).next()
    }
    <b>return</b> <b>true</b>
  }

  newBrancher () {
    <b>return</b> <span style='color:#0057ae;'>BranchSequenceMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>$</span>create(sequence)
  }
}

<b>concrete</b> <b><span style='color:#0057ae;'>BranchSequenceMatcher</span></b><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> {
  <b>refines</b> <span style='color:#0057ae;'>MatchBrancher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>

  <span style='color:#644a9b;'>@type</span> create (<b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span>) -&gt; (<span style='color:#0057ae;'>BranchSequenceMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>)
  <span style='color:#644a9b;'>@value</span> tryBranches (<i><span style='color:#0057ae;'>#c</span></i>) -&gt; (<span style='color:#0057ae;'>MatchState</span>,<b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>BranchSequenceMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span>)
}

<b>define</b> <b><span style='color:#0057ae;'>BranchSequenceMatcher</span></b> {
  <span style='color:#644a9b;'>@value</span> <b>optional</b> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> continued
  <span style='color:#644a9b;'>@value</span> <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> sequence
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Bool</span></i> consumed

  create (sequence) {
    <b>return</b> <span style='color:#0057ae;'>BranchSequenceMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ <b>empty</b>, sequence, <b>false</b> }
  }

  matchSatisfied () {
    <b>if</b> (consumed) {
      <b>return</b> <b>false</b>
    }
    <b>if</b> (<b>present</b>(continued) &amp;&amp; !<b>require</b>(continued).matchSatisfied()) {
      <b>return</b> <b>false</b>
    }
    <b>scoped</b> {
      <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> current &lt;- sequence
    } <b>in</b> <b>while</b> (<b>present</b>(current)) {
      <b>if</b> (!<b>require</b>(current).value().matchesEmpty()) {
        <b>return</b> <b>false</b>
      }
    } <b>update</b> {
      current &lt;- <b>require</b>(current).next()
    }
    <b>return</b> <b>true</b>
  }

  tryBranches (data) {
    <b>if</b> (consumed) {
      <b>return</b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail(), <b>empty</b>
    }
    consumed &lt;- <b>true</b>
    <b>return</b> recursiveBranch(data,continued,sequence)
  }

  <span style='color:#644a9b;'>@type</span> recursiveBranch (<i><span style='color:#0057ae;'>#c</span></i>,<b>optional</b> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>,<b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span>) -&gt;
                        (<span style='color:#0057ae;'>MatchState</span>,<b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>BranchSequenceMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span>)
  recursiveBranch (data,continued,sequence) (state,branch) {
    state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchFail()
    branch &lt;- <b>empty</b>
    <b>if</b> (!<b>present</b>(continued) &amp;&amp; !<b>present</b>(sequence)) {
      <b>return</b> <b>_</b>
    }
    <b>optional</b> <span style='color:#0057ae;'>Matcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> continued2 &lt;- continued
    <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span> sequence2 &lt;- sequence
    <b>if</b> (!<b>present</b>(continued2)) {
      continued2 &lt;- <b>require</b>(sequence2).value().newMatcher()
      sequence2 &lt;- <b>require</b>(sequence2).next()
    }
    <b>if</b> (<b>require</b>(continued2).matchSatisfied()) {
      <span style='color:#0057ae;'>MatchState</span> state2, branch &lt;- recursiveBranch(data,<b>empty</b>,sequence2)
      <b>if</b> (state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>lessThan<b><span style='color:#c02040;'>`</span></b> state2) {
        state &lt;- state2
      }
    }
    <span style='color:#0057ae;'>MatchState</span> state2 &lt;- <b>require</b>(continued2).tryNextMatch(data)
    <b>if</b> (state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>lessThan<b><span style='color:#c02040;'>`</span></b> state2) {
      state &lt;- state2
    }
    <b>if</b> (state2 <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchComplete()) {
      <b>if</b> (<b>present</b>(sequence2)) {
        <span style='color:#898887;'>// Add a branch to continue this sequence.</span>
        branch &lt;- <span style='color:#0057ae;'>LinkedNode</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>BranchSequenceMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span><span style='color:#644a9b;'>$</span>create(
            <span style='color:#0057ae;'>BranchSequenceMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ <b>empty</b>, sequence2, <b>false</b> },branch)
        state &lt;- <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue()
      } <b>else</b> {
        <span style='color:#898887;'>// Add a branch to serve as a record of completeness. It will fail to</span>
        <span style='color:#898887;'>// match anything, but matchSatisfied() will return true.</span>
        branch &lt;- <span style='color:#0057ae;'>LinkedNode</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>BranchSequenceMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span><span style='color:#644a9b;'>$</span>create(
            <span style='color:#0057ae;'>BranchSequenceMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ <b>empty</b>, <b>empty</b>, <b>false</b> },branch)
      }
    } <b>elif</b> (state <b><span style='color:#c02040;'>`</span></b><span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>equals<b><span style='color:#c02040;'>`</span></b> <span style='color:#0057ae;'>MatchState</span><span style='color:#644a9b;'>$</span>matchContinue()) {
        <span style='color:#898887;'>// Add a branch to continue this sequence.</span>
        branch &lt;- <span style='color:#0057ae;'>LinkedNode</span><span style='color:#c02040;'>&lt;</span><span style='color:#0057ae;'>BranchSequenceMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;&gt;</span><span style='color:#644a9b;'>$</span>create(
            <span style='color:#0057ae;'>BranchSequenceMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ continued2, sequence2, <b>false</b> },branch)
    }
  }
}

<b>define</b> <b><span style='color:#0057ae;'>BranchRepeat</span></b> {
  <span style='color:#644a9b;'>@value</span> <span style='color:#0057ae;'>MatcherTemplate</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span> template
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> minCount
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>Int</span></i> maxCount

  createZeroPlus (template) {
    <b>return</b> createRange(<span style='color:#b08000;'>0</span>,<span style='color:#b08000;'>0</span>,template)
  }

  createOnePlus (template) {
    <b>return</b> createRange(<span style='color:#b08000;'>1</span>,<span style='color:#b08000;'>0</span>,template)
  }

  createRange (minCount,maxCount,template) {
    <b>return</b> <span style='color:#0057ae;'>BranchRepeat</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span>{ template, minCount, maxCount }
  }

  matchesEmpty () {
    <b>return</b> minCount &lt;= <span style='color:#b08000;'>0</span> || template.matchesEmpty()
  }

  newBrancher () {
    <b>return</b> <span style='color:#0057ae;'>BranchRepeatMatcher</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#c</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>$</span>create(minCount,maxCount,template)
  }
}

<b>define</b> <b><span style='color:#0057ae;'>LinkedNode</span></b> {
  <span style='color:#644a9b;'>@value</span> <b>optional</b> <span style='color:#0057ae;'>ReadSequence</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span> nextNode
  <span style='color:#644a9b;'>@value</span> <i><span style='color:#0057ae;'>#x</span></i> data

  create (data,nextNode) {
    <b>return</b> <span style='color:#0057ae;'>LinkedNode</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span>{ nextNode, data }
  }

  concatSequences (head1,head2) {
    <b>if</b> (!<b>present</b>(head2)) {
      <b>return</b> head1
    } <b>elif</b> (<b>present</b>(head1)) {
      <b>return</b> <span style='color:#0057ae;'>LinkedNode</span><span style='color:#c02040;'>&lt;</span><i><span style='color:#0057ae;'>#x</span></i><span style='color:#c02040;'>&gt;</span><span style='color:#644a9b;'>$</span>create(<b>require</b>(head1).value(),
                                   concatSequences(<b>require</b>(head1).next(),head2))
    } <b>else</b> {
      <b>return</b> head2
    }
  }

  value () {
    <b>return</b> data
  }

  next () {
    <b>return</b> nextNode
  }
}
</pre>
</body>
</html>
